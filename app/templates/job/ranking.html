{% extends "job/job_base.html" %}
{% load static from staticfiles %}

{% block title %}OTU Rankings for {{ job.name }}{% endblock %}
{% block job_page %}
  <h2>Ranking</h2>
  <p>
    The following ranking is based on the nearest samples in the ecosystem
    criteria selected during the search. Samples are ranked in order of
    closeness to individual samples in the submitted BIOM file. All information
    regarding the similar samples are listed along with the distance between
    the submitted sample and the queried samples. The corresponding barcharts
    (if available) for each sample list a set of clades which are abundant in
    your sample (in relative percentage). Hover over the bars to see more
    information.
  </p>

  <!-- Graph generated by ranking.js -->
  {% for sample in job.samples.all %}
  <section id="ranking-barcharts-{{forloop.counter}}" class="ranking-barcharts-section">
    <div class="row">
      <div class="col-xs-4">
        <h4>Phylum</h4>
        <div class="barchart-container" id="barchart-phylum-{{forloop.counter}}"></div>
      </div>
      <div class="col-xs-4">
        <h4>Family</h4>
        <div class="barchart-container" id="barchart-family-{{forloop.counter}}"></div>
      </div>
      <div class="col-xs-4">
        <h4>Genus</h4>
        <div class="barchart-container" id="barchart-genus-{{forloop.counter}}"></div>
      </div>
    </div>
  </section>
  {% endfor %}

  <section id="ranking-table-section">
    <div class="row">
      <div class="col-xs-12 col-sm-12">
        <ul class="nav nav-tabs" role="tablist">
          {% for sample in job.samples.all %}
            <li role="presentation">
              <a href="#sample-{{forloop.counter}}"
                 class="sample-tab"
                 aria-controls="sample-{{forloop.counter}}"
                 role="tab" data-toggle="tab"
                 data-sample-id="{{forloop.counter}}">{{sample.name}}</a>
            </li>
          {% endfor %}
        </ul>

        <div class="tab-content">
          {% for sample in job.samples.all %}
            <div role="tabpanel" class="tab-pane"
                 id="sample-{{forloop.counter}}">
              <div class="row">
                <div class="col-xs-12"
                     id="sample-{{forloop.counter}}-card-container">
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    </div>

  </section>
{% endblock %}

{% block lazy_js %}

<script src="{% static 'js/d3.v3.min.js'%}" type="text/javascript"></script>
<script src="{% static 'js/mpld3.v0.3.js'%}" type="text/javascript"></script>
<script src="{% static 'js/ranking.js'%}" type="text/javascript"></script>
<script>
  var jobSamplesRankingFile = "{{ ranking_file_path }}";
  var barchartFiles = "{{ barchart_files }}";
  var sampleIds = {{ samples|safe }};
  $(document).ready(function () {
    displayRankings(jobSamplesRankingFile, sampleIds, barchartFiles);
  });
</script>
{% endblock %}
